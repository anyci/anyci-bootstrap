#!/usr/bin/env bash
set -eo pipefail
readonly __ENTRY=$(basename "$0")
log(){ printf "# %-${__lpad:-17}s [${__ll:-INFO}] $*\n" "($__ENTRY)" >&2; }
die(){ __ll=ERR log "$*"; exit 1; }

# prints age of a path in seconds
age() { echo $(( $(date +%s) - $(date -r "$1" +%s) )); }

ANYCI_HOME="${ANYCI_HOME:-$HOME/.anyci}"
ANYCI_URL="${ANYCI_URL:-https://github.com/anyci/anyci.git}"
ANYCI_MAX_AGE="${ANYCI_MAX_AGE:-60}"
ANYCI_SKIP_CLEANUP=${ANYCI_SKIP_CLEANUP:-false}

log "AnyCI repository: $ANYCI_URL"
[ -d "$ANYCI_HOME/anyci-mirror" ] || {
  log "cloning AnyCI repository..."
  git clone --bare --mirror "$ANYCI_URL" "$ANYCI_HOME/anyci-mirror" 2>&1 | sed "s/^/#    /g"
}

last_update="$(age "$ANYCI_HOME/anyci-mirror/objects")"
log "Age of AnyCI repository: ${last_update}s (max age is ${ANYCI_MAX_AGE}s)"
[ "$last_update" -lt "$ANYCI_MAX_AGE" ] || (
  log "updating AnyCI repository..."
  cd "$ANYCI_HOME/anyci-mirror"
  git remote update 2>&1 | sed "s/^/#    /g"
)

ANYCI_ROOT="$(mktemp -d 2>/dev/null || mktemp -d -t 'anyci')"
$ANYCI_SKIP_CLEANUP || trap 'log "cleaning up. ANYCI_SKIP_CLEANUP=true to skip."; rm -rf "$ANYCI_ROOT"' EXIT

log "creating workspace: $ANYCI_ROOT"
git clone -q "$ANYCI_HOME/anyci-mirror" "$ANYCI_ROOT" 2>&1 | sed "s/^/#    /g"

# ci handoff...
cd "$ANYCI_ROOT"
[ -z "$ANYCI_BRANCH" ] || git checkout "$ANYCI_BRANCH" || die "ANYCI_BRANCH checkout failed"
bin/anyci "$@"
